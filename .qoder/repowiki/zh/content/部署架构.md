# 部署架构

<cite>
**本文档中引用的文件**  
- [docker-compose.yml](file://backend/docker-compose.yml)
- [.env](file://backend/.env)
- [.env.template](file://backend/.env.template)
- [medusa-config.ts](file://backend/medusa-config.ts)
- [package.json](file://storefront/package.json)
- [next.config.ts](file://storefront/next.config.ts)
- [.env.example](file://storefront/.env.example)
- [.env.local](file://storefront/.env.local)
</cite>

## 目录

1. [简介](#简介)
2. [后端服务容器化部署](#后端服务容器化部署)
3. [环境变量与安全策略](#环境变量与安全策略)
4. [前端应用构建与静态部署](#前端应用构建与静态部署)
5. [高可用性建议](#高可用性建议)
6. [CI/CD集成与版本管理](#cicd集成与版本管理)

## 简介

Lumiera系统采用微服务架构，后端基于Medusa框架构建，前端使用Next.js开发。本部署架构文档详细描述了从开发到生产环境的完整部署流程，涵盖容器化部署、环境管理、前端静态部署、高可用性设计以及CI/CD集成方案。

## 后端服务容器化部署

Lumiera系统的后端服务通过Docker Compose进行容器化部署，包含PostgreSQL数据库、Redis缓存服务以及Medusa应用服务（隐含在配置中）。`docker-compose.yml`文件定义了所有后端服务的部署配置。

```mermaid
graph TB
subgraph "后端容器网络"
Postgres[PostgreSQL<br/>数据库服务]
Redis[Redis<br/>缓存服务]
Medusa[Medusa<br/>应用服务]
end
Postgres --> Medusa
Redis --> Medusa
```

**图示来源**  
- [docker-compose.yml](file://backend/docker-compose.yml#L1-L31)

### 服务配置详情

**PostgreSQL服务**  
- 镜像版本：`postgres:16`
- 容器名称：`lumiera-postgres`
- 端口映射：主机5432端口映射到容器5432端口
- 数据卷：使用`postgres_data`命名卷持久化数据，挂载至`/var/lib/postgresql/data`
- 健康检查：通过`pg_isready`命令检测数据库就绪状态，每5秒检查一次，超时5秒，最多重试5次
- 环境变量：配置了数据库用户、密码和数据库名称

**Redis服务**  
- 镜像版本：`redis:7-alpine`
- 容器名称：`lumiera-redis`
- 端口映射：主机6379端口映射到容器6379端口
- 健康检查：通过`redis-cli ping`命令检测Redis服务状态，每5秒检查一次，超时5秒，最多重试5次

**服务依赖关系**  
Medusa应用服务依赖于PostgreSQL和Redis服务，通过环境变量中的连接URL建立连接。容器编排确保数据库和缓存服务在应用服务启动前已就绪。

**本节来源**  
- [docker-compose.yml](file://backend/docker-compose.yml#L1-L31)

## 环境变量与安全策略

Lumiera系统通过环境变量文件进行配置管理，实现了开发、测试和生产环境的配置分离。

### 环境变量管理

系统使用`.env`文件管理环境变量，同时提供`.env.template`作为模板文件，指导开发者配置必要的环境变量。

**核心环境变量**  
- `DATABASE_URL`: 数据库连接字符串，格式为`postgres://user:password@host:port/database`
- `REDIS_URL`: Redis连接字符串，格式为`redis://host:port`
- `JWT_SECRET`: JWT令牌签名密钥，用于用户认证
- `COOKIE_SECRET`: Cookie签名密钥，用于会话管理
- `STORE_CORS`, `ADMIN_CORS`, `AUTH_CORS`: CORS策略配置，定义允许访问的前端域名

**环境变量加载机制**  
在`medusa-config.ts`中，系统通过`loadEnv`函数加载环境变量，优先使用`process.env.NODE_ENV`指定的环境文件，若未指定则默认加载开发环境配置。配置文件从环境变量中读取数据库URL、CORS设置、JWT密钥等关键参数。

### 安全策略

**敏感信息保护**  
- `.env`文件包含敏感信息（如数据库密码、API密钥），不应提交到版本控制系统
- `.env.template`文件作为模板，不包含实际密钥值，可安全提交到代码仓库
- 生产环境中，环境变量应通过安全的密钥管理服务（如AWS Secrets Manager、Hashicorp Vault）注入，而非使用文件

**密钥管理**  
- JWT密钥和Cookie密钥在`.env`文件中配置，开发环境使用固定值，生产环境必须使用高强度随机生成的密钥
- `.env.template`中JWT和Cookie密钥的默认值为`supersecret`，仅用于开发，生产环境必须替换

**CORS安全**  
- 通过`STORE_CORS`、`ADMIN_CORS`等环境变量精确控制跨域请求来源
- 生产环境中应严格限制CORS域名，避免使用通配符

**本节来源**  
- [.env](file://backend/.env#L1-L8)
- [.env.template](file://backend/.env.template#L1-L8)
- [medusa-config.ts](file://backend/medusa-config.ts#L1-L20)

## 前端应用构建与静态部署

Lumiera的前端应用基于Next.js框架构建，采用现代化的静态部署方案。

### 构建流程

前端应用的构建通过`yarn build`命令执行，该命令在`package.json`中定义：

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "eslint"
}
```

构建过程包括：
1. 编译TypeScript和JSX代码
2. 优化静态资源（CSS、图片等）
3. 生成静态HTML文件和JavaScript包
4. 应用代码分割和懒加载优化

### 静态部署方案

构建完成后，前端应用可部署到主流静态网站托管平台：

**Vercel部署**  
- Vercel是Next.js的官方托管平台，提供无缝集成
- 支持自动CI/CD，代码推送后自动构建和部署
- 提供全球CDN加速，确保快速加载
- 内置预渲染和边缘函数支持

**Netlify部署**  
- 支持从Git仓库自动部署
- 提供免费SSL证书和自定义域名支持
- 内置表单处理和无服务器函数
- 全球CDN网络

**部署配置**  
`next.config.ts`文件包含关键部署配置：
- 图像优化：开发环境下禁用图像优化，避免私有IP阻塞
- 远程图像模式：配置允许加载的远程图像域名，包括Unsplash、Pexels等
- SVG支持：允许SVG图像渲染
- 内容安全策略：设置严格的安全策略，防止XSS攻击

**环境变量**  
前端使用`.env.local`文件配置环境变量，关键变量包括：
- `NEXT_PUBLIC_MEDUSA_BACKEND_URL`: Medusa后端API地址
- `NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY`: Medusa发布密钥，用于前端API调用
- `NEXT_PUBLIC_GEMINI_API_KEY`: Gemini AI API密钥，用于聊天小部件
- `NEXT_PUBLIC_SITE_URL`: 站点URL，用于SEO和分享

**本节来源**  
- [package.json](file://storefront/package.json#L1-L31)
- [next.config.ts](file://storefront/next.config.ts#L1-L42)
- [.env.example](file://storefront/.env.example#L1-L10)
- [.env.local](file://storefront/.env.local#L1-L11)

## 高可用性建议

为确保Lumiera系统在生产环境的稳定运行，建议实施以下高可用性措施：

### 负载均衡

**应用层负载均衡**  
- 部署多个Medusa应用实例，通过负载均衡器（如Nginx、HAProxy或云服务商的负载均衡服务）分发流量
- 配置健康检查，自动剔除故障实例
- 使用会话粘性（Session Affinity）或外部会话存储（如Redis）处理有状态请求

**数据库读写分离**  
- 配置PostgreSQL主从复制，主库处理写操作，从库处理读操作
- 应用层通过连接池智能路由读写请求

### 数据库备份与恢复

**定期备份**  
- 实施每日全量备份和每小时增量备份策略
- 使用`pg_dump`或`pg_basebackup`工具进行备份
- 备份文件加密存储于安全位置（如S3、Google Cloud Storage）

**备份验证**  
- 定期进行备份恢复演练，确保备份有效性
- 自动化备份完整性检查

**灾难恢复**  
- 在异地数据中心或云区域维护备用数据库实例
- 制定详细的灾难恢复计划（DRP），包括RTO（恢复时间目标）和RPO（恢复点目标）

### 日志监控

**集中式日志**  
- 使用ELK（Elasticsearch, Logstash, Kibana）或EFK（Elasticsearch, Fluentd, Kibana）堆栈收集和分析日志
- 所有服务（Medusa、PostgreSQL、Redis）的日志输出到标准输出，由容器运行时收集
- 添加结构化日志，便于搜索和分析

**监控与告警**  
- 使用Prometheus和Grafana监控系统性能指标（CPU、内存、磁盘I/O、网络流量）
- 监控应用健康端点（如`/health`）
- 设置关键指标告警（如数据库连接数、API响应时间、错误率）
- 集成通知系统（如Slack、邮件、短信）及时通知运维人员

**本节来源**  
- [docker-compose.yml](file://backend/docker-compose.yml#L1-L31)
- [integration-tests/http/health.spec.ts](file://backend/integration-tests/http/health.spec.ts#L1-L15)

## CI/CD集成与版本管理

Lumiera系统支持与CI/CD工具集成，实现自动化部署和版本管理。

### CI/CD集成

**GitHub Actions初步指导**  
创建`.github/workflows/deploy.yml`工作流文件：

```yaml
name: Deploy to Production
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd backend
        yarn install
        cd ../storefront
        yarn install
        
    - name: Build frontend
      run: |
        cd storefront
        yarn build
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /path/to/lumiera
          docker-compose down
          docker-compose up -d --build
```

**关键步骤**  
1. 代码检出
2. Node.js环境设置
3. 依赖安装
4. 前端构建
5. 通过SSH部署到服务器，重建Docker容器

### 版本更新与回滚

**版本更新流程**  
1. 在开发分支完成功能开发和测试
2. 合并到主分支触发CI/CD流水线
3. 自动构建新镜像并部署到生产环境
4. 运行健康检查验证部署成功

**回滚策略**  
- **镜像回滚**：维护之前的Docker镜像标签，回滚时部署旧版本镜像
- **数据库迁移回滚**：使用数据库迁移工具（如Knex.js）管理模式变更，编写可逆的迁移脚本
- **蓝绿部署**：维护两套生产环境，流量切换实现零停机回滚
- **金丝雀发布**：先向少量用户发布新版本，验证无误后再全量发布

**本节来源**  
- [docker-compose.yml](file://backend/docker-compose.yml#L1-L31)
- [package.json](file://storefront/package.json#L1-L31)
- [medusa-config.ts](file://backend/medusa-config.ts#L1-L20)