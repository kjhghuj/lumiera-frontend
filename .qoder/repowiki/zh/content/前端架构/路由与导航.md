# 路由与导航

<cite>
**本文档引用文件**  
- [layout.tsx](file://storefront/src/app/layout.tsx)
- [page.tsx](file://storefront/src/app/page.tsx)
- [product\[handle]\page.tsx](file://storefront/src/app/product\[handle]\page.tsx)
- [journal\[slug]\page.tsx](file://storefront/src/app/journal\[slug]\page.tsx)
- [shop\page.tsx](file://storefront/src/app/shop/page.tsx)
- [medusa.ts](file://storefront/src/lib/medusa.ts)
- [LayoutWrapper.tsx](file://storefront/src/components/LayoutWrapper.tsx)
- [providers.tsx](file://storefront/src/lib/providers.tsx)
</cite>

## 目录
1. [项目结构与路由映射](#项目结构与路由映射)
2. [服务端组件数据获取](#服务端组件数据获取)
3. [布局系统与性能优化](#布局系统与性能优化)
4. [导航机制与状态管理](#导航机制与状态管理)
5. [预加载与懒加载策略](#预加载与懒加载策略)

## 项目结构与路由映射

Lumiera 项目采用 Next.js 16 App Router 架构，通过 `app` 目录下的文件夹结构实现静态与动态路由的映射。每个文件夹代表一个路由路径，其中 `page.tsx` 文件作为页面入口。

- `product\[handle]` 文件夹使用方括号语法定义动态路由参数 `handle`，用于展示特定商品详情页。
- `journal\[slug]` 文件夹同样使用动态参数 `slug`，支持文章详情页的动态生成。
- `shop`、`about`、`cart` 等文件夹对应静态路由，分别映射到商店、关于我们、购物车等页面。

动态路由通过 `generateStaticParams` 函数在构建时生成静态路径，提升加载性能。例如，`product\[handle]\page.tsx` 中调用 `getProducts` 获取所有商品句柄，为每个商品生成独立的静态页面。

**Section sources**
- [product\[handle]\page.tsx](file://storefront/src/app/product\[handle]\page.tsx#L15-L24)
- [journal\[slug]\page.tsx](file://storefront/src/app/journal\[slug]\page.tsx#L11-L15)
- [shop\page.tsx](file://storefront/src/app/shop/page.tsx)

## 服务端组件数据获取

在 App Router 中，`page.tsx` 文件作为服务端组件，负责在服务器端获取数据并渲染页面。数据获取主要通过 `lib/medusa.ts` 中封装的 SDK 方法实现。

- `getProducts` 和 `getProductByHandle` 用于从 Medusa 后端获取商品列表和特定商品信息。
- `getRegion` 获取地区信息，用于价格计算和区域化展示。
- `getCategories` 和 `getCollections` 分别获取商品分类和集合信息，支持筛选和推荐功能。

这些数据获取函数在页面组件中异步调用，确保在页面渲染前完成数据加载。例如，首页通过 `getFeaturedProducts` 组合多个数据源，优先展示“最佳销量”集合中的商品。

**Section sources**
- [page.tsx](file://storefront/src/app/page.tsx#L11-L29)
- [product\[handle]\page.tsx](file://storefront/src/app/product\[handle]\page.tsx#L61-L62)
- [medusa.ts](file://storefront/src/lib/medusa.ts#L31-L123)

## 布局系统与性能优化

`layout.tsx` 文件定义了全局布局结构，通过嵌套布局机制实现不同层级的 UI 共享。根布局包含 HTML 文档结构、字体加载和全局样式，同时引入 `Providers` 组件提供上下文支持。

`LayoutWrapper` 组件封装了导航栏、页脚、搜索弹窗等共享 UI 元素，通过客户端组件（Client Component）实现交互功能。服务端获取的 `region` 和 `cart` 数据通过上下文传递给客户端组件，实现服务端与客户端的数据协同。

共享布局减少了重复渲染，提升了整体性能。同时，`revalidate` 配置实现了页面的增量静态再生（ISR），每 60 秒重新验证数据，平衡了静态生成与动态更新的需求。

**Section sources**
- [layout.tsx](file://storefront/src/app/layout.tsx)
- [LayoutWrapper.tsx](file://storefront/src/components/LayoutWrapper.tsx)
- [providers.tsx](file://storefront/src/lib/providers.tsx)

## 导航机制与状态管理

页面间导航主要通过 Next.js 的 `Link` 组件实现，支持客户端路由跳转，避免整页刷新。URL 参数通过 `searchParams` 传递，如 `shop` 页面根据 `category` 和 `sort` 参数进行商品筛选和排序。

状态管理通过 React Context 实现，`Providers` 组件封装了 `CartContext` 和 `RegionContext`，提供购物车和区域数据的全局访问。`useCart` 和 `useRegion` 自定义 Hook 简化了状态读取和更新操作。

购物车状态存储在 `localStorage` 中，通过 `cartId` 持久化用户会话。添加、更新和删除商品的操作通过 Medusa SDK 异步更新，并实时刷新 UI。

**Section sources**
- [shop\page.tsx](file://storefront/src/app/shop/page.tsx#L9-L24)
- [cart\page.tsx](file://storefront/src/app/cart/page.tsx#L408-L432)
- [providers.tsx](file://storefront/src/lib/providers.tsx)

## 预加载与懒加载策略

Next.js 自动对链接目标页面进行预加载，提升导航体验。当用户悬停在 `Link` 组件上时，目标页面的 JavaScript 资源会被提前加载，实现无缝跳转。

对于非关键组件，如搜索弹窗和年龄验证模态框，采用动态导入（`dynamic`）实现懒加载，减少首屏加载时间。`Suspense` 组件用于处理异步组件的加载状态，提供骨架屏或占位符。

这些策略共同优化了用户体验，在保证功能完整性的同时，最大限度地提升了性能表现。

**Section sources**
- [cart\page.tsx](file://storefront/src/app/cart/page.tsx#L1-L513)
- [LayoutWrapper.tsx](file://storefront/src/components/LayoutWrapper.tsx#L20-L24)